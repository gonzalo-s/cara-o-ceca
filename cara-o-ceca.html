<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Cara o Ceca</title>
	</head>
	<style>
		#flipButton {
			background-color: brown;
		}
		#finalResultView {
			display: none;
		}
	</style>
	<body>
		<h1>Cara o Ceca</h1>
		<form id="setupForm">
			seleccionar cantidad de rondas
			<ul>
				<li>
					<input
						type="radio"
						id="one"
						name="roundsNumber"
						value="1"
					/>
					<label for="1">1</label>
				</li>
				<li>
					<input
						type="radio"
						id="three"
						name="roundsNumber"
						value="3"
					/>
					<label for="3">3</label>
				</li>
				<li>
					<input
						type="radio"
						id="five"
						name="roundsNumber"
						value="5"
					/>
					<label for="5">5</label>
				</li>
			</ul>
			<button id="startGame" type="submit">Start Game</button>
		</form>
		<form id="gameForm">
			<ul>
				<li class="option">
					<input type="radio" id="cara" name="lado" value="cara" />
					<label for="cara">Cara</label>
				</li>
				<li class="option">
					<input type="radio" id="ceca" name="lado" value="ceca" />
					<label for="ceca">Ceca</label>
				</li>
			</ul>
			<button id="flipButton" type="submit">
				Flip
			</button>
		</form>
		<div id="roundTable">
			<div>Rondas: <span id="roundsCountDisplay"></span></div>
			<div></div>
		</div>
		<div id="gameTable">
			<div>Games: <span id="gamesCountDisplay"></span></div>

			<div></div>
		</div>
		<div id="finalMenu">
			<button id="backToMenu">VOLVER AL MENU</button>
			<button id="restartGame">VOLVER A JUGAR</button>
		</div>
		<!-- 	
		<div id="finalResultView">Ganador: <span id="finalResult"></span></div>	
		<div id="partialResult"></div>
		<div id="errorMessage">error:</div>
	 -->

		<script>
			// guardar una referencia al formulario en una variable form
			const options = ['cara', 'ceca']
			let gameHistory
			let selectedRoundsNumber = 0
			const gameForm = document.querySelector('#gameForm')
			const gameTable = document.querySelector('#gameTable')
			const roundTable = document.querySelector('#roundTable')
			const setupForm = document.querySelector('#setupForm')
			const roundsCountDisplay = document.querySelector(
				'#roundsCountDisplay'
			)
			const gamesCountDisplay = document.querySelector(
				'#gamesCountDisplay'
			)
			const errorMessage = document.querySelector('#errorMessage')
			const partialResult = document.querySelector('#partialResult')
			const finalResult = document.querySelector('#finalResult')
			const finalResultView = document.querySelector('#finalResultView')
			const flipButton = gameForm.querySelector('#flipButton')
			let backToMenu = document.querySelector('#backToMenu')
			let restartGame = document.querySelector('#restartGame')
			let finalMenu = document.querySelector('#finalMenu')

			// TODO: mejor nombre
			let rounds

			//) Vista 1 (INICIO DEL JUEGO)
			setInicioDelJuego()
			function setInicioDelJuego() {
				setupForm.style.display = 'block'
				setupForm.one.checked = false
				setupForm.three.checked = true //default
				setupForm.five.checked = false
				gameForm.style.display = 'none'
				gameTable.style.display = 'none'
				roundTable.style.display = 'none'
				finalMenu.style.display = 'none'
				selectedRoundsNumber = getSelectedRoundsNumber()
				rounds = []
				gameHistory = []
				roundsCountDisplay.textContent = 0
				gameForm.cara.checked = false
				gameForm.ceca.checked = false
				flipButton.disabled = true
				//partialResult.textContent = ''
				//finalResult.textContent = ''
				//finalResultView.style.display = 'none'
				//errorMessage.textContent = 'seleccionar cara o ceca'
			}
			setupForm.addEventListener('submit', (event) => {
				event.preventDefault()
				selectedRoundsNumber = getSelectedRoundsNumber()
				setupForm.style.display = 'none'
				gameForm.style.display = 'block'
				roundTable.style.display = 'block'
				//gameTable.style.display = 'block'
			})
			function getSelectedRoundsNumber() {
				const data = new FormData(setupForm)
				for (const entry of data) {
					if (entry[0] === 'roundsNumber') {
						return entry[1]
					}
				}
				return null
			}

			//Fin de la primer vista "Inicio del Juego"

			if (getSelectedLado()) {
				partialResult.textContent = ''
			}

			//extraer lado seleccionado de form con formdata
			function getSelectedLado() {
				const data = new FormData(gameForm)
				for (const entry of data) {
					if (entry[0] === 'lado') {
						return entry[1]
					}
				}
				return null
			}

			function getRandomInt(min, max) {
				min = Math.ceil(min)
				max = Math.floor(max)
				return Math.floor(Math.random() * (max - min)) + min //The maximum is exclusive and the minimum is inclusive
			}

			gameForm.addEventListener('change', () => {
				if (getSelectedLado()) {
					flipButton.disabled = false
				}
			})

			// ))Ejecuta la función que procesa cada ronda VISTA 2 (RONDAS)
			gameForm.addEventListener('submit', (event) => {
				event.preventDefault()
				// Calcula si el usuario gano la ronda

				let userLado = getSelectedLado()

				if (userLado === null) {
					flipButton.disabled = true
					return
				}

				const machineLadoIdx = getRandomInt(0, options.length)
				const machineLado = options[machineLadoIdx]

				if (machineLado === userLado) {
					rounds.push(true)
				} else {
					rounds.push(false)
				}
				// Computa valores para poder razonar las reglas del juego de manera semántica
				let flipCount = rounds.length
				console.log('rounds', rounds)

				let roundsWonByUser = rounds.filter((r) => r).length
				let roundsLostByUser = rounds.length - roundsWonByUser

				console.log(
					'rounds won by user ',
					roundsWonByUser,

					'rounds lost by user ',
					roundsLostByUser
				)

				roundsCountDisplay.textContent = flipCount

				// Chequea si se completo un Game
				let roundsWonLimit = Math.ceil(selectedRoundsNumber / 2)
				console.log(
					'rounds number ',
					selectedRoundsNumber,
					'rounds won limit ',
					roundsWonLimit,
					'flip Count ',
					flipCount
				)

				// mejor de 3, termina el game cuando:
				// 		* 3 rounds
				//		* usuario gano 2 rounds
				//		* usuario perdio 2 rounds
				//
				// mejor de 5, termina el game cuando:
				//		* 5 rounds
				//		* usuario gano 3 rounds
				//		* usuario perdio 3 rounds
				//
				//

				if (roundsWonByUser === roundsWonLimit) {
					flipButton.disabled = true
					if (gameHistory.length === 3) {
						gameHistory.shift()
					}
					gameHistory.push({ win: true, result: rounds })
					console.log('GAME ENDED:', gameHistory)
					gameTable.style.display = 'block'
					finalMenu.style.display = 'block'

					gameForm.style.display = 'none'
					roundTable.style.display = 'block'
				} else if (roundsLostByUser === roundsWonLimit) {
					flipButton.disabled = true
					if (gameHistory.length === 3) {
						gameHistory.shift()
					}
					gameHistory.push({ win: false, result: rounds })
					console.log('GAME ENDED:', gameHistory)
					gameTable.style.display = 'block'
					finalMenu.style.display = 'block'

					gameForm.style.display = 'none'
					roundTable.style.display = 'block'
					//gameForm.style.display = 'none'
					//finalResult.textContent = userWon ? 'Ganaste' : 'Perdiste'
					//finalResultView.style.display = 'block'
				}
			})

			//))) menu final
			backToMenu.addEventListener('click', () => {
				gameForm.style.display = 'block'
				finalMenu.style.display = 'none'
				rounds = []
				roundsCountDisplay.textContent = 0
				gameForm.cara.checked = false
				gameForm.ceca.checked = false
				console.log(rounds)
			})
			restartGame.addEventListener('click', () => {
				setInicioDelJuego()
			})
		</script>
	</body>
</html>
