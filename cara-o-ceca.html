<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Cara o Ceca</title>
	</head>
	<style>
		#flipButton {
			background-color: brown;
		}
		#finalResultView {
			display: none;
		}
	</style>
	<body>
		<h1>Cara o Ceca</h1>
		<form id="gameForm">
			<ul>
				<li class="option">
					<input type="radio" id="cara" name="lado" value="cara" />
					<label for="cara">Cara</label>
				</li>
				<li class="option">
					<input type="radio" id="ceca" name="lado" value="ceca" />
					<label for="ceca">Ceca</label>
				</li>
			</ul>
			<button id="flipButton" type="submit">
				Flip
			</button>
		</form>

		<form id="setupForm">
			seleccionar cantidad de rondas
			<ul>
				<li>
					<input
						type="radio"
						id="one"
						name="roundsNumber"
						value="1"
					/>
					<label for="1">1</label>
				</li>
				<li>
					<input
						type="radio"
						id="three"
						name="roundsNumber"
						value="3"
					/>
					<label for="3">3</label>
				</li>
				<li>
					<input
						type="radio"
						id="five"
						name="roundsNumber"
						value="5"
					/>
					<label for="5">5</label>
				</li>
			</ul>
			<button id="startGame" type="submit">Start Game</button>
		</form>
		<div id="gameTable">
			<div>Intentos: <span id="flipCountDisplay"></span></div>
			<div>Moneda: <span id="flipSide"></span></div>
			<div id="errorMessage">error:</div>
			<div id="partialResult"></div>
			<div id="finalResultView">
				Ganador: <span id="finalResult"></span>
			</div>
			<button id="resetButton">RESET</button>
			<button id="resetHistoryButton">RESET HISTORY</button>
		</div>
		<script>
			// guardar una referencia al formulario en una variable form
			const options = ['cara', 'ceca']
			let gameHistory = []
			let selectedRoundsNumber = 0
			const gameForm = document.querySelector('#gameForm')
			const gameTable = document.querySelector('#gameTable')
			const setupForm = document.querySelector('#setupForm')
			const flipCountDisplay = document.querySelector('#flipCountDisplay')
			const flipSide = document.querySelector('#flipSide')
			const errorMessage = document.querySelector('#errorMessage')
			const partialResult = document.querySelector('#partialResult')
			const finalResult = document.querySelector('#finalResult')
			const finalResultView = document.querySelector('#finalResultView')
			const flipButton = gameForm.querySelector('#flipButton')
			let resetButton = document.querySelector('#resetButton')
			let resetHistoryButton = document.querySelector(
				'#resetHistoryButton'
			)

			// TODO: mejor nombre
			let rounds

			//Vista INICIO DEL JUEGO
			setInicioDelJuego()
			function setInicioDelJuego() {
				setupForm.one.checked = false
				setupForm.three.checked = true //default
				setupForm.five.checked = false
				gameForm.style.display = 'none'
				gameTable.style.display = 'none'
				selectedRoundsNumber = getSelectedRoundsNumber()
				//rounds = []
				//flipCountDisplay.textContent = 0
				//flipButton.disabled = true
				//partialResult.textContent = ''
				//finalResult.textContent = ''
				//flipSide.textContent = ''
				//finalResultView.style.display = 'none'
				//errorMessage.textContent = 'seleccionar cara o ceca'
				//gameForm.cara.checked = false
				//gameForm.ceca.checked = false
			}
			setupForm.addEventListener('submit', (event) => {
				event.preventDefault()
				selectedRoundsNumber = getSelectedRoundsNumber()
				setupForm.style.display = 'none'

				gameForm.style.display = 'block'
				gameTable.style.display = 'block'
			})
			function getSelectedRoundsNumber() {
				const data = new FormData(setupForm)
				for (const entry of data) {
					if (entry[0] === 'roundsNumber') {
						return entry[1]
					}
				}
				return null
			}

			if (getSelectedLado()) {
				partialResult.textContent = ''
			}

			//extraer lado seleccionado de form con formdata
			function getSelectedLado() {
				const data = new FormData(gameForm)
				for (const entry of data) {
					if (entry[0] === 'lado') {
						return entry[1]
					}
				}
				return null
			}

			function getRandomInt(min, max) {
				min = Math.ceil(min)
				max = Math.floor(max)
				return Math.floor(Math.random() * (max - min)) + min //The maximum is exclusive and the minimum is inclusive
			}

			resetButton.addEventListener('click', () => {
				//resetear todo para volver a empezar
				setInicioDelJuego()
			})

			resetHistoryButton.addEventListener('click', () => {
				if (gameHistory !== []) {
					return (gameHistory = ['']), console.log(gameHistory)
				}
				return gameHistory
			})

			gameForm.addEventListener('change', () => {
				if (getSelectedLado()) {
					errorMessage.textContent = ''
					flipButton.disabled = false
				}
			})

			// Ejecuta la función que procesa cada ronda
			gameForm.addEventListener('submit', (event) => {
				event.preventDefault()

				errorMessage.textContent = ''

				// Calcula si el usuario gano la ronda

				let userLado = getSelectedLado()

				if (userLado === null) {
					errorMessage.textContent = 'seleccionar cara o ceca'
					return
				}

				const machineLadoIdx = getRandomInt(0, options.length)
				const machineLado = options[machineLadoIdx]
				flipSide.textContent = machineLado

				if (machineLado === userLado) {
					partialResult.textContent = 'Ganaste'
					rounds.push(true)
				} else {
					partialResult.textContent = 'Perdiste'
					rounds.push(false)
				}

				// Computa valores para poder razonar las reglas del juego de manera semántica
				let flipCount = rounds.length
				let roundsWonByUser = rounds.filter((r) => r).length

				flipCountDisplay.textContent = flipCount

				console.log('round', {
					total: flipCount,
					wonByUser: roundsWonByUser,
				})

				// Chqeuea si se completo un Game
				if (
					flipCount === 3 ||
					roundsWonByUser === 2 ||
					(flipCount === 2 && roundsWonByUser === 0)
				) {
					let userWon = roundsWonByUser === 2

					gameHistory.push(userWon)

					console.log('game ended', {
						userWon,
						history: gameHistory,
					})

					gameForm.style.display = 'none'
					finalResult.textContent = userWon ? 'Ganaste' : 'Perdiste'
					flipButton.disabled = true
					finalResultView.style.display = 'block'
				}
			})
		</script>
	</body>
</html>
