<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Cara o Ceca</title>
	</head>
	<style>
		#flipButton {
			background-color: brown;
		}
		#finalResultView {
			display: none;
		}
	</style>
	<body>
		<h1>Cara o Ceca</h1>
		<form>
			<ul>
				<li class="option">
					<input type="radio" id="cara" name="lado" value="cara" />
					<label for="cara">Cara</label>
				</li>
				<li class="option">
					<input type="radio" id="ceca" name="lado" value="ceca" />
					<label for="ceca">Ceca</label>
				</li>
			</ul>
			<button id="flipButton" type="submit">
				Flip
			</button>
		</form>
		<div>Intentos: <span id="flipCountDisplay"></span></div>
		<div>Moneda: <span id="flipSide"></span></div>
		<div id="errorMessage">error:</div>
		<div id="partialResult"></div>
		<div id="finalResultView">Ganador: <span id="finalResult"></span></div>
		<button id="resetButton">RESET</button>
		<button id="resetHistoryButton">RESET HISTORY</button>

		<script>
			// guardar una referencia al formulario en una variable form
			const options = ['cara', 'ceca']
			let gameHistory = []
			const form = document.querySelector('form')
			const flipCountDisplay = document.querySelector('#flipCountDisplay')
			const flipSide = document.querySelector('#flipSide')
			const errorMessage = document.querySelector('#errorMessage')
			const partialResult = document.querySelector('#partialResult')
			const finalResult = document.querySelector('#finalResult')
			const finalResultView = document.querySelector('#finalResultView')
			const flipButton = form.querySelector('#flipButton')
			let resetButton = document.querySelector('#resetButton')
			let resetHistoryButton = document.querySelector(
				'#resetHistoryButton'
			)

			// TODO: mejor nombre
			let winner
			let rounds

			setInitialState()
			function setInitialState() {
				winner = ''
				rounds = []
				flipCountDisplay.textContent = 0
				flipButton.disabled = true
				partialResult.textContent = ''
				finalResult.textContent = ''
				flipSide.textContent = ''
				finalResultView.style.display = ''
				errorMessage.textContent = 'seleccionar cara o ceca'
				form.cara.checked = false
				form.ceca.checked = false
			}

			if (getSelectedLado()) {
				partialResult.textContent = ''
			}

			//extraer lado seleccionado de form con formdata
			function getSelectedLado() {
				const data = new FormData(form)
				for (const entry of data) {
					if (entry[0] === 'lado') {
						return entry[1]
					}
				}
				return null
			}

			function getRandomInt(min, max) {
				min = Math.ceil(min)
				max = Math.floor(max)
				return Math.floor(Math.random() * (max - min)) + min //The maximum is exclusive and the minimum is inclusive
			}

			resetButton.addEventListener('click', () => {
				//resetear todo para volver a empezar
				setInitialState()
			})

			resetHistoryButton.addEventListener('click', () => {
				if (gameHistory !== []) {
					return (gameHistory = ['']), console.log(gameHistory)
				}
				return gameHistory
			})

			form.addEventListener('change', () => {
				if (getSelectedLado()) {
					errorMessage.textContent = ''
					flipButton.disabled = false
					// si cambia de opcion cara o ceca resetear intentos SOLO si ya hay un ganador
					if (winner) {
						resetHistorialResult()
						flipCountDisplay.textContent = 0
					}
					console.log(winner)
				}
			})

			form.addEventListener('submit', (event) => {
				event.preventDefault()

				errorMessage.textContent = ''

				let userLado = getSelectedLado()

				if (userLado === null) {
					errorMessage.textContent = 'seleccionar cara o ceca'
					return
				}
				const machineLadoIdx = getRandomInt(0, options.length)
				const machineLado = options[machineLadoIdx]
				flipSide.textContent = machineLado
				//console.log({ userLado, machineLado })
				//calculo del resultado del partial match
				if (machineLado === userLado) {
					partialResult.textContent = 'Ganaste'
					rounds.push(true)
				} else {
					partialResult.textContent = 'Perdiste'
					rounds.push(false)
				}

				let flipCount = rounds.length
				let roundsWonByUser = rounds.filter((r) => r).length

				flipCountDisplay.textContent = flipCount

				console.log('round', {
					total: flipCount,
					wonByUser: roundsWonByUser,
				})

				//ver quien es el ganador FINAL, 2 ganados

				if (
					flipCount === 3 ||
					roundsWonByUser === 2 ||
					(flipCount === 2 && roundsWonByUser === 0)
				) {
					// ver quien es el winner, la maquina o el humano y seguir

					gameHistory.push(roundsWonByUser === 2)

					console.log('game ended', {
						userWon: roundsWonByUser === 2,
						history: gameHistory,
					})

					finalResult.textContent = winner
					flipButton.disabled = true
					finalResultView.style.display = 'block'

					//(ok)  ver logica de mejor de 3, 2 ganados seguidos = ganador
					//(ok)  mostrar mensajes partialResult y finalResult
					// historial de games ganados / perdidos
					//(ok)  reset para volver a jugar
					//(ok)  		- ocultar boton de flip
					//(ok)  		- resetear contador
					// 		- agregar al hisotrial el reslutado
					//(uso RESET)       - agregar boton de "volver a jugar"
				}
			})
		</script>
	</body>
</html>
